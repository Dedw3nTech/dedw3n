The correct startup process for implementing health checks and other middleware in ASP.NET Core involves two main phases: service registration in the dependency injection container and middleware configuration in the request processing pipeline. 
Phase 1: Register Health Check Services 
In the Program.cs file (or Startup.ConfigureServices in older templates), you register health check services and any specific checks with the dependency injection container. This should happen before calling builder.Build(). 
csharp
var builder = WebApplication.CreateBuilder(args);

// 1. Register other application services (e.g., MVC, Entity Framework, Authentication, CORS)
builder.Services.AddControllersWithViews();
builder.Services.AddAuthentication();
builder.Services.AddAuthorization();
builder.Services.AddCors(options => { /* ... */ });

// 2. Register Health Checks services
builder.Services.AddHealthChecks()
    .AddSqlServer(builder.Configuration.GetConnectionString("DefaultConnection"), name: "SQL DB Check") // Example for a database check
    .AddCheck<CustomHealthCheck>("Custom Check"); // Example for a custom check

// 3. Build the application host
var app = builder.Build();
Phase 2: Configure the Middleware Pipeline 
After building the app instance, you define the HTTP request pipeline by adding middleware in a specific order using app.Use... or app.Map... methods. The order is crucial as each middleware processes the request sequentially. 
A recommended general order for the middleware pipeline is as follows:
Exception/Error Handling: Place this first to catch exceptions from all subsequent middleware.
csharp
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}
else
{
    app.UseExceptionHandler("/Home/Error");
    app.UseHsts();
}
HTTPS Redirection: Redirects HTTP requests to HTTPS.
csharp
app.UseHttpsRedirection();
Static Files: Serves static files (CSS, JS, images); short-circuits the pipeline if a static file is found.
csharp
app.UseStaticFiles();
Routing: Matches the request URL to an endpoint.
csharp
app.UseRouting();
CORS: Configures Cross-Origin Resource Sharing (if required, must be after Routing for endpoint-specific policies).
csharp
app.UseCors("MyCorsPolicy");
Authentication & Authorization: Authenticates the user and checks their permissions.
csharp
app.UseAuthentication();
app.UseAuthorization();
Health Checks Endpoint: Map the health checks middleware to a specific URL path. This middleware is a terminal middleware and short-circuits the pipeline if the request matches the endpoint (e.g., /healthz or /readyz), preventing further middleware from executing for health check requests.
csharp
app.MapHealthChecks("/healthz", new HealthCheckOptions
{
    // Optional: Customize response format for monitoring systems (e.g., JSON)
    // ResponseWriter = UIResponseWriter.WriteHealthCheckUIResponse
});
// For separate liveness/readiness checks in containerized environments (like Kubernetes)
// app.MapHealthChecks("/healthz/ready", new HealthCheckOptions { Predicate = healthCheck => healthCheck.Tags.Contains("ready") });
// app.MapHealthChecks("/healthz/live", new HealthCheckOptions { Predicate = _ => false });
Session/Other Middleware: Any other specific middleware the application needs.
csharp
// app.UseSession();
Endpoint Mapping: Maps controllers, Razor Pages, etc. If no endpoint is matched by previous middleware, this will handle the request.
csharp
app.MapControllers();
// or app.MapRazorPages();
Run the application:
csharp
app.Run();
